SET SERVEROUTPUT ON
/
alter session set "_ORACLE_SCRIPT"=true;
/
-- DROP USER
CREATE OR REPLACE PROCEDURE USER_SP_DROP_USER
AS
BEGIN
    FOR USR IN (SELECT MANV FROM ATBMHTTT_TABLE_NHANVIEN)
    LOOP
        BEGIN
            EXECUTE IMMEDIATE 'DROP USER ' || USR.MANV || ' CASCADE';
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('DROP ' || USR.MANV || ' DONT SUCCESS');
        END;
    END LOOP;
END USER_SP_DROP_USER;
/
BEGIN
    USER_SP_DROP_USER;
END;
/
ALTER TABLE ATBMHTTT_TABLE_NHANVIEN
DROP CONSTRAINT FK_NHANVIEN_NHANVIEN;

ALTER TABLE ATBMHTTT_TABLE_NHANVIEN
DROP CONSTRAINT IN_VAITRO;

ALTER TABLE ATBMHTTT_TABLE_NHANVIEN
DROP CONSTRAINT FK_NHANVIEN_PHONGBAN;

ALTER TABLE ATBMHTTT_TABLE_PHONGBAN
DROP CONSTRAINT FK_PHONGBAN_NHANVIEN;

ALTER TABLE ATBMHTTT_TABLE_DEAN
DROP CONSTRAINT FK_DEAN_PHONGBAN;

ALTER TABLE ATBMHTTT_TABLE_PHANCONG
DROP CONSTRAINT FK_PHANCONG_NHANVIEN;

ALTER TABLE ATBMHTTT_TABLE_PHANCONG
DROP CONSTRAINT FK_PHANCONG_DEAN;

DROP TABLE ATBMHTTT_TABLE_NHANVIEN;
DROP TABLE ATBMHTTT_TABLE_PHONGBAN;
DROP TABLE ATBMHTTT_TABLE_DEAN;
DROP TABLE ATBMHTTT_TABLE_PHANCONG;

DROP ROLE ATBMHTTT_ROLE_NHANVIEN;
DROP ROLE ATBMHTTT_ROLE_QLTRUCTIEP;
DROP ROLE ATBMHTTT_ROLE_TRUONGPHONG;
DROP ROLE ATBMHTTT_ROLE_TAICHINH;
DROP ROLE ATBMHTTT_ROLE_NHANSU;
DROP ROLE ATBMHTTT_ROLE_TRUONGDEAN;
/
-- Tao cau truc bang
CREATE TABLE ATBMHTTT_TABLE_NHANVIEN
(
    MANV CHAR(5),
    TENNV VARCHAR2(50),
    PHAI VARCHAR2(9),
    NGAYSINH DATE,
    DIACHI VARCHAR2(200),
    SODT CHAR(10),
    LUONG NUMBER(7,2),
    PHUCAP NUMBER(7,2),
    VAITRO  VARCHAR2(50),
    MANQL CHAR(5),
    PHG CHAR(5) NOT NULL,
    CONSTRAINT ATBMHTTT_TABLE_NHANVIEN_PK PRIMARY KEY (MANV)
);
/
CREATE TABLE ATBMHTTT_TABLE_PHONGBAN
(
    MAPB CHAR(5),
    TENPB VARCHAR2(50),
    TRPHG CHAR(5),
    CONSTRAINT ATBMHTTT_TABLE_PHONGBAN_PK PRIMARY KEY (MAPB)
);


CREATE TABLE ATBMHTTT_TABLE_DEAN
(
    MADA CHAR(5),
    TENDA VARCHAR2(100),
    NGAYBD DATE,
    PHONG CHAR(5),
    CONSTRAINT ATBMHTTT_TABLE_DEAN_PK PRIMARY KEY (MADA)
);
/
CREATE TABLE ATBMHTTT_TABLE_PHANCONG
(
    MANV CHAR(5),
    MADA CHAR(5),
    THOIGIAN DATE,
    CONSTRAINT ATBMHTTT_TABLE_PHANCONG_PK PRIMARY KEY (MANV,MADA)
);
/

-- Tao khoa ngoai
ALTER TABLE ATBMHTTT_TABLE_NHANVIEN
ADD CONSTRAINT FK_NHANVIEN_NHANVIEN FOREIGN KEY (MANQL) REFERENCES ATBMHTTT_TABLE_NHANVIEN(MANV);

ALTER TABLE ATBMHTTT_TABLE_NHANVIEN
ADD CONSTRAINT IN_VAITRO CHECK (VAITRO IN ('NHÂN VIÊN', 'QUẢN LÝ TRỰC TIẾP', 'TRƯỞNG PHÒNG', 'TÀI CHÍNH', 'NHÂN SỰ', 'TRƯỞNG ĐỀ ÁN', 'BAN GIÁM ĐỐC'));

ALTER TABLE ATBMHTTT_TABLE_NHANVIEN
ADD CONSTRAINT FK_NHANVIEN_PHONGBAN FOREIGN KEY (PHG) REFERENCES ATBMHTTT_TABLE_PHONGBAN(MAPB);

ALTER TABLE ATBMHTTT_TABLE_PHONGBAN
ADD CONSTRAINT FK_PHONGBAN_NHANVIEN FOREIGN KEY (TRPHG) REFERENCES ATBMHTTT_TABLE_NHANVIEN(MANV);

ALTER TABLE ATBMHTTT_TABLE_DEAN
ADD CONSTRAINT FK_DEAN_PHONGBAN FOREIGN KEY (PHONG) REFERENCES ATBMHTTT_TABLE_PHONGBAN(MAPB);

ALTER TABLE ATBMHTTT_TABLE_PHANCONG
ADD CONSTRAINT FK_PHANCONG_NHANVIEN FOREIGN KEY (MANV) REFERENCES ATBMHTTT_TABLE_NHANVIEN(MANV);

ALTER TABLE ATBMHTTT_TABLE_PHANCONG
ADD CONSTRAINT FK_PHANCONG_DEAN FOREIGN KEY (MADA) REFERENCES ATBMHTTT_TABLE_DEAN(MADA);
/
-- Them du lieu vao bang
-- Bang ATBMHTTT_TABLE_PHONGBAN
INSERT INTO ATBMHTTT_TABLE_PHONGBAN(MAPB, TENPB, TRPHG) VALUES ('PB001', 'PHÒNG KẾ TOÁN', NULL);
INSERT INTO ATBMHTTT_TABLE_PHONGBAN(MAPB, TENPB, TRPHG) VALUES ('PB002', 'PHÒNG TÀI CHÍNH', NULL);
INSERT INTO ATBMHTTT_TABLE_PHONGBAN(MAPB, TENPB, TRPHG) VALUES ('PB003', 'PHÒNG NHÂN SỰ', NULL);
INSERT INTO ATBMHTTT_TABLE_PHONGBAN(MAPB, TENPB, TRPHG) VALUES ('PB004', 'PHÒNG KINH DOANH', NULL);
INSERT INTO ATBMHTTT_TABLE_PHONGBAN(MAPB, TENPB, TRPHG) VALUES ('PB005', 'PHÒNG MARKETING', NULL);
INSERT INTO ATBMHTTT_TABLE_PHONGBAN(MAPB, TENPB, TRPHG) VALUES ('PB006', 'PHÒNG KĨ THUẬT', NULL);
/
-- Bang ATBMHTTT_TABLE_DEAN
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA001', 'XÂY DỰNG HỆ THỐNG QUẢN LÝ TÀI LIỆU ĐIỆN TỬ', TO_DATE('01-03-2023', 'DD-MM-YYYY'), 'PB001');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA002', 'QUẢN LÝ CHI PHÍ', TO_DATE('02-03-2023', 'DD-MM-YYYY'), 'PB001');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA003', 'TỔ CHỨC HỆ THỐNG KẾ TOÁN', TO_DATE('03-03-2023', 'DD-MM-YYYY'), 'PB001');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA004', 'TẠO BẢNG KÊ KHAI THUẾ', TO_DATE('04-03-2023', 'DD-MM-YYYY'), 'PB002');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA005', 'PHÂN TÍCH TÀI CHÍNH', TO_DATE('10-03-2023', 'DD-MM-YYYY'), 'PB002');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA006', 'QUẢN LÝ TÀI SẢN CỐ ĐỊNH', TO_DATE('15-03-2023', 'DD-MM-YYYY'), 'PB002');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA007', 'QUẢN LÝ HIỆU SUẤT NHÂN VIÊN', TO_DATE('20-03-2023', 'DD-MM-YYYY'), 'PB003');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA008', 'THIẾT KẾ CHÍNH SÁCH NHÂN SỰ', TO_DATE('01-01-2023', 'DD-MM-YYYY'), 'PB003');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA009', 'XÂY DỰNG HỆ THỐNG ĐÁNH GIÁ NHÂN VIÊN', TO_DATE('10-01-2023', 'DD-MM-YYYY'), 'PB003');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA010', 'PHÁT TRIỂN KẾ HOẠCH KINH DOANH', TO_DATE('11-02-2023', 'DD-MM-YYYY'), 'PB004');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA011', 'PHÁT TRIỂN CHIẾN LƯỢC TIẾP THỊ SẢN PHẨM', TO_DATE('08-02-2023', 'DD-MM-YYYY'), 'PB004');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA012', 'PHÂN TÍCH VÀ DỰ BÁO THỊ TRƯỜNG', TO_DATE('07-03-2023', 'DD-MM-YYYY'), 'PB004');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA013', 'PHÁT TRIỂN THƯƠNG HIỆU', TO_DATE('01-12-2022', 'DD-MM-YYYY'), 'PB005');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA014', 'QUẢN LÝ CHIẾN DỊCH QUẢNG CÁO', TO_DATE('12-02-2022', 'DD-MM-YYYY'), 'PB005');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA015', 'TĂNG CƯỜNG DIGITAL MARKETING', TO_DATE('11-04-2022', 'DD-MM-YYYY'), 'PB005');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA019', 'PHÂN TÍCH CẠNH TRANH', TO_DATE('18-08-2022', 'DD-MM-YYYY'), 'PB006');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA020', 'NGHIÊN CỨU THỊ TRƯỜNG', TO_DATE('14-03-2022', 'DD-MM-YYYY'), 'PB006');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA016', 'PHÁT TRIỂN PHẦN MỀM ỨNG DỤNG', TO_DATE('08-06-2022', 'DD-MM-YYYY'), 'PB006');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA017', 'CÀI ĐẶT HỆ THỐNG CÔNG NGHỆ THÔNG TIN', TO_DATE('11-11-2022', 'DD-MM-YYYY'), 'PB005');
INSERT INTO ATBMHTTT_TABLE_DEAN(MADA, TENDA, NGAYBD, PHONG) VALUES('DA018', 'THIẾT KẾ MẠCH ĐIỆN TỬ', TO_DATE('01-10-2022', 'DD-MM-YYYY'), 'PB004');

/

/
INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV001', 'CHLOE MITCHELL', 'NAM', TO_DATE('15-05-1985','DD-MM-YYYY'), '01 Bạch Đằng, Hải Châu, Đà Nẵng', '0909876543', 2500, 100, 'TRƯỞNG PHÒNG', NULL, 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV002', 'JOHN DOE', 'NAM', TO_DATE('10-08-1990','DD-MM-YYYY'), '123 Phan Đình Phùng, Ba Đình, Hà Nội', '0987654321', 3000, 150, 'TRƯỞNG PHÒNG', NULL, 'PB002');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV003', 'JANE DOE', 'NỮ', TO_DATE('03-12-1992','DD-MM-YYYY'), '123 Phan Đình Phùng, Ba Đình, Hà Nội', '0976543210', 2800, 120, 'TRƯỞNG PHÒNG', NULL, 'PB003');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV004', 'MICHAEL SMITH', 'NAM', TO_DATE('20-06-1988','DD-MM-YYYY'), '123 Trần Quang Diệu, Hà Nội', '0965432109', 3200, 200, 'TRƯỞNG PHÒNG', NULL, 'PB004');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV005', 'EMMA JOHNSON', 'NỮ', TO_DATE('05-02-1991','DD-MM-YYYY'), '69 Hàm Tôn Quyền, Hà Nội', '0987654321', 3000, 150, 'TRƯỞNG PHÒNG', NULL, 'PB005');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV006', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '69 Hàm Tôn Quyền, Hà Nội', '0987654321', 3000, 150, 'TRƯỞNG PHÒNG', NULL, 'PB006');

-- UPDATE PHONG BAN
UPDATE ATBMHTTT_TABLE_PHONGBAN
SET TRPHG = 'NV001'
WHERE MAPB = 'PB001';

UPDATE ATBMHTTT_TABLE_PHONGBAN
SET TRPHG = 'NV002'
WHERE MAPB = 'PB002';


UPDATE ATBMHTTT_TABLE_PHONGBAN
SET TRPHG = 'NV003'
WHERE MAPB = 'PB003';

UPDATE ATBMHTTT_TABLE_PHONGBAN
SET TRPHG = 'NV004'
WHERE MAPB = 'PB004';

UPDATE ATBMHTTT_TABLE_PHONGBAN
SET TRPHG = 'NV005'
WHERE MAPB = 'PB005';

UPDATE ATBMHTTT_TABLE_PHONGBAN
SET TRPHG = 'NV006'
WHERE MAPB = 'PB006';

-- INSERT Q

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV007', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '456 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0976543210', 2800, 120, 'QUẢN LÝ TRỰC TIẾP', NULL, 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV008', 'JANE NGUYEN', 'NỮ', TO_DATE('20-08-1993','DD-MM-YYYY'), '33 TRẦN PHÚ, QUẬN 5, TP. HỒ CHÍ MINH', '0912345678', 3000, 150, 'QUẢN LÝ TRỰC TIẾP', NULL, 'PB002');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV009', 'JOSHUA TRAN', 'NAM', TO_DATE('28-02-1988','DD-MM-YYYY'), '11 HOÀNG DIỆU, PHƯỜNG 7, QUẬN 4, TP. HỒ CHÍ MINH', '0987654321', 3200, 180, 'QUẢN LÝ TRỰC TIẾP', NULL, 'PB002');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV010', 'LILY TRAN', 'NỮ', TO_DATE('05-10-1990','DD-MM-YYYY'), '123 NGUYỄN CHÍ THANH, ĐÀ NẴNG', '0911112222', 2700, 100, 'QUẢN LÝ TRỰC TIẾP', NULL, 'PB003');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV011', 'JIMMY NGUYEN', 'NAM', TO_DATE('15-12-1985','DD-MM-YYYY'), '25 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0987654321', 2900, 130, 'QUẢN LÝ TRỰC TIẾP', NULL, 'PB003');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV012', 'JESSICA TRAN', 'NỮ', TO_DATE('01-05-1994','DD-MM-YYYY'), '456 HOÀNG DIỆU, PHƯỜNG 6, QUẬN 4, TP. HỒ CHÍ MINH', '0909998888', 3100, 170, 'QUẢN LÝ TRỰC TIẾP', 'NV003', 'PB003');
/
-- INSERT 'TÀI CHÍNH'
INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV013', 'KIM JUNG MIN', 'NỮ', TO_DATE('12-04-1993','DD-MM-YYYY'), '123 HUỲNH VĂN BÁNH, PHÚ NHUẬN, HCM', '0987654321', 3000, 150, 'TÀI CHÍNH', 'NV012', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV014', 'LEE HYO RI', 'NỮ', TO_DATE('30-05-1991','DD-MM-YYYY'), '789 LÊ QUANG ĐỊNH, BÌNH THẠNH, HCM', '0965432109', 3200, 180, 'TÀI CHÍNH', 'NV011', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV015', 'LEE CHANG SUNG', 'NAM', TO_DATE('25-12-1987','DD-MM-YYYY'), '456 ĐỒNG KHỞI, QUẬN 1, HCM', '0932123456', 3500, 200, 'TÀI CHÍNH', 'NV010', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV016', 'KIM TAE HEE', 'NỮ', TO_DATE('29-03-1986','DD-MM-YYYY'), '789 LÊ DUẨN, QUẬN 1, HCM', '0909123456', 3800, 250, 'TÀI CHÍNH', 'NV009', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV017', 'SONG JOONG KI', 'NAM', TO_DATE('19-09-1985','DD-MM-YYYY'), '01 PHAN ĐÌNH PHÙNG, BA ĐÌNH, HÀ NỘI', '0918234567', 4000, 300, 'TÀI CHÍNH', 'NV008', 'PB001');
/
-- INSERT 'NHÂN SỰ'
INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV018', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '456 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0976543210', 2800, 120, 'NHÂN SỰ', 'NV012', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV019', 'EMMA JONES', 'NỮ', TO_DATE('21-07-1993','DD-MM-YYYY'), '5 NGUYỄN TRÃI, THANH XUÂN, HÀ NỘI', '0912345678', 2900, 130, 'NHÂN SỰ', 'NV011', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV020', 'EMMA JONES', 'NỮ', TO_DATE('21-07-1993','DD-MM-YYYY'), '5 NGUYỄN TRÃI, THANH XUÂN, HÀ NỘI', '0912345678', 2900, 130, 'NHÂN SỰ', 'NV010', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV021', 'EMMA JONES', 'NỮ', TO_DATE('21-07-1993','DD-MM-YYYY'), '5 NGUYỄN TRÃI, THANH XUÂN, HÀ NỘI', '0912345678', 2900, 130, 'NHÂN SỰ', 'NV009', 'PB002');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV022', 'EMMA JONES', 'NỮ', TO_DATE('21-07-1993','DD-MM-YYYY'), '5 NGUYỄN TRÃI, THANH XUÂN, HÀ NỘI', '0912345678', 2900, 130, 'NHÂN SỰ', 'NV008', 'PB002');

-- INSERT 'BAN GIÁM ĐỐC'
INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV023', 'ANNA KIM', 'NỮ', TO_DATE('11-04-1990','DD-MM-YYYY'), '12 NGUYỄN TRÃI, Q1, TP.HCM', '0908765432', 3000, 150, 'BAN GIÁM ĐỐC', 'NV003', 'PB003');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV024', 'JACK SMITH', 'NAM', TO_DATE('23-08-1993','DD-MM-YYYY'), '223 LÊ VĂN VIỆT, Q9, TP.HCM', '0901234567', 3500, 200, 'BAN GIÁM ĐỐC', 'NV002', 'PB002');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV025', 'EMMA JONES', 'NỮ', TO_DATE('19-01-1987','DD-MM-YYYY'), '25 ĐÀO TẤN, BA ĐÌNH, HÀ NỘI', '0912345678', 4000, 250, 'BAN GIÁM ĐỐC', 'NV005', 'PB005');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV026', 'ANDREW LEE', 'NAM', TO_DATE('02-05-1992','DD-MM-YYYY'), '67 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0987654321', 4500, 300, 'BAN GIÁM ĐỐC', 'NV003', 'PB003');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV027', 'SARA WONG', 'NỮ', TO_DATE('10-12-1989','DD-MM-YYYY'), '28 TRẦN DUY HÙNG, TRUNG HÒA, HÀ NỘI', '0987123456', 5000, 350, 'BAN GIÁM ĐỐC', 'NV004', 'PB004');
/

-- INSERT 'TRƯỞNG ĐỀ ÁN'
INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV028', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '456 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0976543210', 2800, 120, 'TRƯỞNG ĐỀ ÁN', 'NV001', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV029', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '456 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0976543210', 2800, 120, 'TRƯỞNG ĐỀ ÁN', 'NV001', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV030', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '456 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0976543210', 2800, 120, 'TRƯỞNG ĐỀ ÁN', 'NV001', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV031', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '456 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0976543210', 2800, 120, 'TRƯỞNG ĐỀ ÁN', 'NV001', 'PB001');

INSERT INTO ATBMHTTT_TABLE_NHANVIEN(MANV, TENNV, PHAI, NGAYSINH, DIACHI, SODT, LUONG, PHUCAP, VAITRO, MANQL, PHG)
VALUES('NV032', 'JASON LEE', 'NAM', TO_DATE('08-11-1995','DD-MM-YYYY'), '456 PHẠM VĂN ĐỒNG, CẦU GIẤY, HÀ NỘI', '0976543210', 2800, 120, 'TRƯỞNG ĐỀ ÁN', 'NV001', 'PB001');
/

--Bang ATBMHTTT_TABLE_PHANCONG
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV001', 'DA001', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV002', 'DA001', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV003', 'DA001', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV004', 'DA004', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV005', 'DA004', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV006', 'DA004', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV007', 'DA004', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV008', 'DA007', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV009', 'DA007', TO_DATE('02-03-2023','DD-MM-YYYY'));
INSERT INTO ATBMHTTT_TABLE_PHANCONG(MANV, MADA, THOIGIAN) VALUES ('NV010', 'DA007', TO_DATE('02-03-2023','DD-MM-YYYY'));
-- CREATE_ROLES
-- Tao ROLE
CREATE ROLE ATBMHTTT_ROLE_NHANVIEN;
/
CREATE ROLE ATBMHTTT_ROLE_QLTRUCTIEP;
/
CREATE ROLE ATBMHTTT_ROLE_TRUONGPHONG;
/
CREATE ROLE ATBMHTTT_ROLE_TAICHINH;
/
CREATE ROLE ATBMHTTT_ROLE_NHANSU;
/
CREATE ROLE ATBMHTTT_ROLE_TRUONGDEAN;
/
CREATE ROLE ATBMHTTT_ROLE_GIAMDOC;
/

-- CREATE USER
CREATE OR REPLACE PROCEDURE USER_SP_CREATE_USER
AS
BEGIN
    FOR USR IN (SELECT MANV FROM ATBM_20H3T_22.ATBMHTTT_TABLE_NHANVIEN)
    LOOP
        BEGIN
            EXECUTE IMMEDIATE 'CREATE USER ' || USR.MANV || ' IDENTIFIED BY ' || USR.MANV;
            EXECUTE IMMEDIATE 'GRANT CREATE SESSION TO ' || USR.MANV;
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('USER ' || USR.MANV || ' ALREADY');
        END;
    END LOOP;
END;
/
--grant role nhanvien
CREATE OR REPLACE PROCEDURE USER_SP_GRANT_USER_TO_ROLE (
    VAITRO_USERS ATBMHTTT_TABLE_NHANVIEN.VAITRO%TYPE,
    ROLE_USER VARCHAR2)
AS
BEGIN
    FOR USR IN (SELECT MANV FROM ATBMHTTT_TABLE_NHANVIEN WHERE VAITRO = VAITRO_USERS)
    LOOP
        BEGIN
            EXECUTE IMMEDIATE 'GRANT '|| ROLE_USER || ' TO ' || USR.MANV;
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('GRANT ROLE '|| ROLE_USER || ' TO ' || USR.MANV || ' DONT SUCCESS');
        END;
    END LOOP;
END;
/

BEGIN
--    USER_SP_CREATE_USER;
    USER_SP_GRANT_USER_TO_ROLE('NHÂN VIÊN','ATBMHTTT_ROLE_NHANVIEN');
    USER_SP_GRANT_USER_TO_ROLE('QUẢN LÝ TRỰC TIẾP','ATBMHTTT_ROLE_QLTRUCTIEP');
    USER_SP_GRANT_USER_TO_ROLE('TRƯỞNG PHÒNG','ATBMHTTT_ROLE_TRUONGPHONG');
    USER_SP_GRANT_USER_TO_ROLE('TÀI CHÍNH','ATBMHTTT_ROLE_TAICHINH');
    USER_SP_GRANT_USER_TO_ROLE('NHÂN SỰ','ATBMHTTT_ROLE_NHANSU');
    USER_SP_GRANT_USER_TO_ROLE('TRƯỞNG ĐỀ ÁN','ATBMHTTT_ROLE_TRUONGDEAN');
    USER_SP_GRANT_USER_TO_ROLE('BAN GIÁM ĐỐC','ATBMHTTT_ROLE_GIAMDOC');
END;
/
SELECT * FROM ALL_USERS WHERE USERNAME LIKE 'NV%';

CREATE USER NV001 IDENTIFIED BY NV001;
GRANT CREATE SESSION TO NV001;

CREATE USER NV002 IDENTIFIED BY NV002;
GRANT CREATE SESSION TO NV002;

CREATE USER NV003 IDENTIFIED BY NV003;
GRANT CREATE SESSION TO NV003;

CREATE USER NV004 IDENTIFIED BY NV004;
GRANT CREATE SESSION TO NV004;

CREATE USER NV005 IDENTIFIED BY NV005;
GRANT CREATE SESSION TO NV005;

CREATE USER NV006 IDENTIFIED BY NV006;
GRANT CREATE SESSION TO NV006;

CREATE USER NV007 IDENTIFIED BY NV007;
GRANT CREATE SESSION TO NV007;

CREATE USER NV008 IDENTIFIED BY NV008;
GRANT CREATE SESSION TO NV008;

CREATE USER NV009 IDENTIFIED BY NV009;
GRANT CREATE SESSION TO NV009;

select * from dba_role_privs where granted_role =  'ATBMHTTT_ROLE_TRUONGPHONG'
----- BÃ€I LÃ€M -----
CREATE OR REPLACE PROCEDURE USER_SP_PRIVILEGE(
    COUNT_GRANT OUT NUMBER,
    USERNAME DBA_TAB_PRIVS.GRANTEE%TYPE, 
    TABLE_NAME VARCHAR2, 
    PRIV_NAME VARCHAR2, 
    GRANT_OPTION NUMBER, 
    GRANT_PRIV NUMBER)
AS
    RAISE_MISSING EXCEPTION;
BEGIN
    IF(GRANT_PRIV = 0) THEN
        RAISE RAISE_MISSING;
    ELSIF(GRANT_PRIV = 1 AND GRANT_OPTION = 0) THEN
        BEGIN
            EXECUTE IMMEDIATE ('GRANT ' || PRIV_NAME ||' ON '|| TABLE_NAME || ' TO ' || USERNAME);
            COUNT_GRANT := COUNT_GRANT + 1;
        END;
    ELSIF (GRANT_PRIV = 1 AND GRANT_OPTION = 1) THEN
        BEGIN
            EXECUTE IMMEDIATE ('GRANT SELECT ON '|| TABLE_NAME || ' TO ' || USERNAME || ' WITH GRANT OPTION');
            COUNT_GRANT := COUNT_GRANT + 1;
        END;
    END IF;
EXCEPTION
    WHEN RAISE_MISSING THEN
        DBMS_OUTPUT.PUT_LINE(' KHÃ”NG Cáº¤P QUYá»€N ' || PRIV_NAME || ' TRÃŠN Báº¢NG ' || TABLE_NAME || ' CHO USER ' || USERNAME);
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE(' Lá»–I Há»† THá»?NG');
END;
/
CREATE OR REPLACE PROCEDURE USER_SP_PRIV_TO_USER(
    USERNAME DBA_TAB_PRIVS.GRANTEE%TYPE,
    TABLE_NAME VARCHAR2, 
    GRANT_SELECT NUMBER, 
    GRANT_INSERT NUMBER, 
    GRANT_UPDATE NUMBER, 
    GRANT_DELETE NUMBER, 
    GRANT_OPTION NUMBER, 
    MESSAGE OUT VARCHAR2)
AS
    COUNT_GRANT NUMBER := 0;
    PRIV_MISSING EXCEPTION;
BEGIN
    IF ((GRANT_SELECT != 0 AND GRANT_SELECT != 1) OR ((GRANT_INSERT != 0 AND GRANT_INSERT != 1))
        OR (GRANT_UPDATE != 0 AND GRANT_UPDATE != 1) OR (GRANT_DELETE != 0 AND GRANT_DELETE != 1)
        OR (GRANT_OPTION != 0 AND GRANT_OPTION != 1)) THEN
            RAISE PRIV_MISSING;
    ELSE
        IF ( GRANT_SELECT = 0 AND GRANT_INSERT = 0 AND GRANT_UPDATE = 0 AND GRANT_DELETE = 0) THEN
            RAISE PRIV_MISSING;
        ELSE
            BEGIN 
                -- GRANT SELECT ON TABLE_NAME TO USERNAME
                USER_SP_PRIVILEGE(COUNT_GRANT, USERNAME, TABLE_NAME, 'SELECT', GRANT_OPTION, GRANT_SELECT);
                -- GRANT INSERT ON TABLE_NAME TO USERNAME
                USER_SP_PRIVILEGE(COUNT_GRANT, USERNAME, TABLE_NAME, 'INSERT', GRANT_OPTION, GRANT_INSERT);
                -- GRANT UPDATE ON TABLE_NAME TO USERNAME
                USER_SP_PRIVILEGE(COUNT_GRANT, USERNAME, TABLE_NAME, 'UPDATE', GRANT_OPTION, GRANT_UPDATE);
                -- GRANT DELETE ON TABLE_NAME TO USERNAME
                USER_SP_PRIVILEGE(COUNT_GRANT, USERNAME, TABLE_NAME, 'DELETE', GRANT_OPTION, GRANT_DELETE);
            END;
        END IF;
        MESSAGE := 'Ä?Ãƒ Cáº¤P ' || COUNT_GRANT || ' QUYá»€N'; 
    END IF;
EXCEPTION
    WHEN PRIV_MISSING THEN
        BEGIN
            MESSAGE := ' KHÃ”NG CÃ“ QUYá»€N Ä?Æ¯á»¢C Cáº¤P';
            DBMS_OUTPUT.PUT_LINE(' KHÃ”NG CÃ“ QUYá»€N Ä?Æ¯á»¢C Cáº¤P');
        END;
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE(' Lá»–I Há»† THá»?NG');
END;
/
-- SELECT PRIVILEGE OF USER 
CREATE OR REPLACE PROCEDURE USER_SP_SELECT_PRIVS_OF_USER (
    USER_NAME ATBMHTTT_TABLE_NHANVIEN.MANV%TYPE)
    AS
        CUR SYS_REFCURSOR;
    BEGIN
        OPEN CUR FOR SELECT TABLE_NAME, PRIVILEGE FROM ROLE_TAB_PRIVS 
                        WHERE ROLE IN (SELECT GRANTED_ROLE 
                                            FROM dba_role_privs 
                                            WHERE GRANTEE = USER_NAME)
                        UNION
                        SELECT TABLE_NAME, PRIVILEGE
                            FROM USER_TAB_PRIVS 
                            WHERE GRANTEE = USER_NAME;
        DBMS_SQL.RETURN_RESULT(CUR);
    END;
/
--BEGIN
--    USER_SP_SELECT_PRIVS_OF_USER ('NV001');
--END;
--/
DROP PROCEDURE USER_SP_ShowAllUsers;
CREATE OR REPLACE PROCEDURE USER_SP_ShowAllUsers (USERS OUT SYS_REFCURSOR)
IS
BEGIN
    OPEN USERS FOR
    SELECT * FROM dba_users;
END;
/
DROP PROCEDURE USER_SP_ShowPrivsUserandRole;
CREATE OR REPLACE PROCEDURE USER_SP_ShowPrivsUserandRole(NAME IN VARCHAR2, PRIVS_UR OUT SYS_REFCURSOR)
IS
BEGIN
    OPEN PRIVS_UR FOR
    SELECT * FROM DBA_TAB_PRIVS WHERE GRANTEE = NAME;
END;
/
CREATE OR REPLACE PROCEDURE USER_SP_ShowAllRoles (ROLES OUT SYS_REFCURSOR)
IS
BEGIN
    OPEN ROLES FOR
    SELECT ROLE_ID, ROLE, PASSWORD_REQUIRED,AUTHENTICATION_TYPE, COMMON FROM DBA_ROLES WHERE ROLE LIKE 'ATBMHTTT_ROLE_%' AND ROLE NOT LIKE 'RE%' AND ROLE NOT LIKE 'RD%'
    ORDER BY ROLE ASC;
END;
/
create or replace Procedure USER_SP_ShowAllTables (TABS OUT SYS_REFCURSOR)
Is
Begin
    OPEN TABS FOR
    SELECT table_name
    FROM user_tables
    Where table_name like 'A%'
    UNION ALL
    SELECT view_name
    FROM user_views 
    Where view_name like 'UV%';
End;
/
